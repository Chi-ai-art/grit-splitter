<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3×3dayo｜画像分割ツール</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }

    body {
      background: #0f172a;
      color: #e2e8f0;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-weight: 900;
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .badge {
      display: inline-block;
      margin-bottom: 20px;
      background: transparent;
      color: #ffffff;
      font-size: 1.2rem;
      font-weight: bold;
      border: 2px solid #fff;
      border-radius: 12px;
      padding: 6px 14px;
      letter-spacing: 1px;
    }

    #dropZone {
      width: 100%;
      max-width: 350px;
      height: 350px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      margin: 0 auto 20px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    #dropZone span {
      opacity: .7;
    }

    img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }

    #tilesWrapper {
      width: 100%;
      max-width: 350px;
      margin: 18px auto 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .tile {
      width: 100%;
      aspect-ratio: 1;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
    }

    button {
      border: none;
      padding: 12px 16px;
      margin: 6px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      background: #3b82f6;
    }

    button:hover {
      opacity: 0.85;
    }
  </style>
</head>

<body>

  <h1>3×3dayo</h1>
  <div class="badge">画像をサクッと分割✊✨</div>

  <input type="file" id="fileInput" accept="image/*" hidden />

  <div id="dropZone">
    <span>ここに画像をドラッグ or クリックして選択</span>
  </div>

  <div id="tilesWrapper"></div>

  <button id="zipBtn" style="display:none;">一括保存（ZIP）</button>
  <button id="resetBtn" style="display:none;">新しく作る</button>

  <script>
    const fileInput = document.getElementById("fileInput");
    const dropZone = document.getElementById("dropZone");
    const tilesWrapper = document.getElementById("tilesWrapper");
    const zipBtn = document.getElementById("zipBtn");
    const resetBtn = document.getElementById("resetBtn");

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.style.opacity = 0.6;
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.style.opacity = 1;
    });

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.style.opacity = 1;
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    function handleFile(file) {
      const img = new Image();
      img.src = URL.createObjectURL(file);

      img.onload = () => {
        dropZone.innerHTML = "";
        dropZone.appendChild(img);

        tilesWrapper.innerHTML = "";
        const cropSize = Math.min(img.width, img.height);

        const tileSize = cropSize / 3;
        let tiles = [];

        for (let y = 0; y < 3; y++) {
          for (let x = 0; x < 3; x++) {
            const canvas = document.createElement("canvas");
            canvas.width = tileSize;
            canvas.height = tileSize;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(
              img,
              x * tileSize,
              y * tileSize,
              tileSize,
              tileSize,
              0,
              0,
              tileSize,
              tileSize
            );

            const tileImg = new Image();
            tileImg.className = "tile";
            tileImg.src = canvas.toDataURL("image/png");
            tilesWrapper.appendChild(tileImg);

            tiles.push({
              name: `tile_${y}_${x}.png`,
              data: canvas.toDataURL("image/png")
            });
          }
        }

        zipBtn.style.display = "inline-block";
        resetBtn.style.display = "inline-block";

        zipBtn.onclick = () => downloadZip(tiles);
      };
    }

    function downloadZip(tiles) {
      import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js').then(JSZipModule => {
        const JSZip = JSZipModule.default;
        const zip = new JSZip();

        tiles.forEach(tile => {
          zip.file(tile.name, tile.data.split(",")[1], { base64: true });
        });

        zip.generateAsync({ type: "blob" }).then(content => {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = "3x3_tiles.zip";
          link.click();
        });
      });
    }

    resetBtn.addEventListener("click", () => {
      tilesWrapper.innerHTML = "";
      dropZone.innerHTML = `<span>ここに画像をドラッグ or クリックして選択</span>`;
      fileInput.value = "";
      zipBtn.style.display = "none";
      resetBtn.style.display = "none";
    });
  </script>

</body>
</html>
